---
title: "Multivariate Assignment - 1"
author: "Elena Ortega - Damiano Alessi - Xieru Song - Aharon V. Zúñiga."
date: "October - 2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
editor_options: 
chunk_output_type: console
---


```{r setup, include=FALSE}
library(maptools)
library(dplyr)
library(Matrix.utils)
library(ggplot2)
library(lavaan)
library(candisc)
library(semTools)
library(semPlot)
library(knitr)
library(tables)
knitr::opts_chunk$set(echo = TRUE)
```

# [Descriptive & Basis analysis] 

### Descriptive & Basis analysis
 Here is a descriptive analysis in order to get information.
```{r step_1}
load("wvs.Rdata")
summary(wvs[,1:10])
zscore <- function(x) {
  zscore <- (x-mean(x))/sd(x)
  } 
```

# [PCA + Biplot of value items] 

### PCA + Biplot of value items
 Standardize the 10 items that measure values of the respondents (see Table 1) and compute  a matrix of 34  countries x 10 items that includes in each cell the mean score of respondents  in a country on a standardized item. Next apply principal components analysis to the data matrix, and make a biplot. Discuss what you can conclude from the PCA and the biplot. 
 
```{r p1_step_1}
#### Decision, the first component will have the maximun variance of the raw data.  here explanation  (empirical analysis)
zgspraw <- apply(wvs[,1:10],2,zscore) 
zgspraw <- cbind(zgspraw,country=wvs$country)
summary(zgspraw)
```

```{r p1_step_2}

av <- mean(zgspraw[,1])
c<-aggregate.Matrix(zgspraw, groupings = zgspraw[,'country',drop=FALSE],fun='mean')
c <-as.matrix(c)

```

```{r p1_step_3}

pcaraw <-prcomp(c[,1:10]) 
attributes(pcaraw)
#variance
round(pcaraw$sdev^2,2)
# proportion of explained variance per component ****
round(pcaraw$sdev^2/10,5)

# compute component loadings #pcaraw$rotation
A<-pcaraw$rotation%*%diag(pcaraw$sdev) #%*% multiplication matrix

#loading multiplied by variance of each variable
plot(A[,1:2],xlab="PC1",ylab="PC2")

pointLabel(A[,1],A[,2],names(wvs[,1:10]),
   cex=1) 

####
# compute unstandardized component scores
Zun<-zgspraw[,1:10]%*%pcaraw$rotation[,1:10]
# compute standardized component scores
Zs<-zgspraw[,1:10]%*%pcaraw$rotation[,1:10]%*%diag(1/pcaraw$sdev[1:10])
# plot component scores for first 2 unstandardized components
plot(Zun[,1:2],xlim=c(-3,8),ylim=c(-3,3),xlab="PC1",ylab="PC2")
#pointLabel(Zun[,1],Zun[,2],wvs[,10],cex=0.9) 

```


# [Exploratory factor analysis (EFA)] 

### Exploratory factor analysis (EFA)
Standardize the 14 justifiability items (see Table 3) and use exploratory factor analysis to summarize the scores on the 14 items using meaningful factors. Discuss how well the selected factor model fits the data and interpret the extracted factors.
Save the factor scores for the selected model and visualize (for each extracted factor) the distribution of the factor scores for the 34 countries. Discuss what you can conclude from these graphs.

```{r p2_step_1}
#print matrix of observed correlations

zjustif <- apply(wvs[,16:29],2,zscore) 
cormat <- round(cor(zjustif),2)
covmat <- round(cov(zjustif),2)

#round(cov(wvs[,16:29]),2) when data is not stadarized, we see the differences.

## estimate EFA with xxx common factors
## The factanal() function runs EFA on the correlation matrix
fa_justif <-factanal(zjustif, factors=7, rotation="none")
fa_justif


#EFA with varimax rotation and 3 factors - varimax orthogonal - prohibited cor.
favm_justif<-factanal(zjustif,factors=3, rotation="varimax")
print(favm_justif, digits = 3, cutoff = 0.4, sort = TRUE)

#EFA with promax rotation and 4 factors - promax oblique - allows correlation between factors
favm_justif2 <- factanal(zjustif,factors=4, rotation="promax")
print(favm_justif2, digits = 3, cutoff = 0.4, sort = TRUE)

pjustif<-prcomp(zjustif)
screeplot(pjustif,type="lines")

## score -- I choose towards to find a explanation in 3 areas. Financial issues
## interpersonal issues and Violence. 
favm_justif<-factanal(zjustif,factors=3, rotation="varimax",scores="regression")
print(favm_justif, digits = 3, cutoff = 0.5, sort = TRUE)
scores <- favm_justif$scores
colnames(scores)<-c("Interpersonal","Financial", "Violence")
zjustif_score <- data.frame(zjustif,scores,country=wvs$country)

ggplot(data = zjustif_score,aes(Interpersonal, fill=country)) +
  geom_density()  + 
 facet_wrap(~country) + theme(legend.position = "none") +
  ggtitle("Factor 1 - Interpersonal Justification")
  
ggplot(data = zjustif_score,aes(Financial, fill=country)) +
  geom_density()  + 
 facet_wrap(~country) + theme(legend.position = "none") +
  ggtitle("Factor 2 - Financial Justification")

ggplot(data = zjustif_score,aes(Violence, fill=country)) +
  geom_density()  + 
 facet_wrap(~country) + theme(legend.position = "none") +
  ggtitle("Factor 3 - Violence Justification")

##### standarise.

```


# [Confirmatory factor analysis (CFA)] 

### Confirmatory factor analysis (CFA)
Select the data of the countries “Netherlands” and “Malaysia” and conduct confirmatory factor analysis on the covariance matrix of the justifiability items (see Table 3). Use your insights obtained with the EFA to specify a confirmatory factor analysis model in which each item is constrained to have a loading on one factor.
Check the fit of the CFA model, and use modification indices to see whether you can adapt the model (in a number of steps) to obtain a parsimonious model with acceptable fit. Discuss the results of the selected CFA model (e.g., fit measures, (standardized) loadings, reliability of the factor scores, factor correlations, etc.).
Conduct a multi-group analysis to assess to what extent there is measurement invariance across the two countries and discuss the results.

```{r p3_step_1}
#pas <- wvs[wvs$country %in% c("Netherlands","Malaysia"),]
#tail(pas)
zjustif_cfa <- apply(wvs[wvs$country %in% c("Netherlands","Malaysia"),16:29],2,zscore)
covmat_cfa <- cov(zjustif_cfa) #no round to get more detailed data

cfa3 <- 'Interpersonal =~ 1*J_homosexuality+J_prostitution+J_abortion+J_divorce+J_sex_before_marriage+J_suicide
   Financial =~ 1*J_claiming_benefits+J_avoiding_fare+J_stealing_property+J_cheating_taxes+J_accept_bribe
   Violence =~ 1*J_beat_wife+ J_parents_beating_children+J_violence
   Financial ~~ Violence
   Violence =~ J_suicide
   Violence =~ J_prostitution'

fitcfa3 <- cfa(cfa3, sample.cov = covmat_cfa, sample.nobs = 2473)

summary(fitcfa3, fit.measures=TRUE)
standardizedSolution(fitcfa3)
modificationIndices(fitcfa3, minimum.value = 10, sort = TRUE)


semPaths(fitcfa3,"model","std","lisrel", edge.label.cex = 1.2, intercepts = FALSE, layout = "tree2",
panelGroups = FALSE, ask = FALSE, groups = "latent", pastel = TRUE, exoCov = TRUE, rotation = 1)


```

# [Structural equation model (SEM)] 

### Structural equation model (SEM)
Continue working on the data of the countries “Netherlands” and “Malaysia”. Estimate a structural equation model to investigate how the importance of religion affects the justifiability of behaviors for respondents. Does the result of the analysis differ for respondents of the two countries?

```{r p4_step_1}
#pas <- wvs[wvs$country %in% c("Netherlands","Malaysia"),]
#tail(pas)
zjustif_cfa <- apply(wvs[wvs$country %in% c("Netherlands","Malaysia"),16:29],2,zscore)
covmat_cfa <- cov(zjustif_cfa) #no round to get more detailed data

cfa3 <- 'Interpersonal =~ 1*J_homosexuality+J_prostitution+J_abortion+J_divorce+J_sex_before_marriage+J_suicide
   Financial =~ 1*J_claiming_benefits+J_avoiding_fare+J_stealing_property+J_cheating_taxes+J_accept_bribe
   Violence =~ 1*J_beat_wife+ J_parents_beating_children+J_violence'

fitcfa3 <- cfa(cfa3, sample.cov = covmat_cfa, sample.nobs = 2473)

summary(fitcfa3, fit.measures=TRUE)
standardizedSolution(fitcfa3)
modificationIndices(fitcfa3, minimum.value = 10, sort = TRUE)


semPaths(fitcfa3,"model","std","lisrel", edge.label.cex = 1.2, intercepts = FALSE, layout = "tree2",
panelGroups = FALSE, ask = FALSE, groups = "latent", pastel = TRUE, exoCov = TRUE, rotation = 1)


```

# [Canonical Correlation Analysis] 

### Canonical correlation analysis
Conduct a canonical correlation analysis to investigate the relations between the following two sets of variables: 
  * Set of X variables: 3 items about importance of religion __(see Table 4)__ and 5 items about occurrence of crimes in the neighborhood __(see Table 2)__.  
  * Set of Y variables: 14 items about the justifiability of behaviors __(see Table 3)__.

Conduct the analysis on standardized items using the data of the countries “Netherlands”
and “Malaysia”.

 Here the first step creating both set of variables 
 
```{r 5step_1}
 set_x <- c("R_attend_religious_services","R_pray","R_importance_God", "CR_robberies", "CR_alcohol", "CR_police_military", "CR_racist_behavior", "CR_drug_sale")
  
set_y <- c("J_avoiding_fare", "J_stealing_property", "J_cheating_taxes", "J_accept_bribe", "J_homosexuality", "J_prostitution", "J_abortion", "J_divorce", "J_sex_before_marriage", "J_suicide", "J_beat_wife", "J_parents_beating_children", "J_violence")

ds <- wvs[wvs$country %in% c("Netherlands","Malaysia"),c(set_x, set_y, "country")]
str(ds)
 
#conduct canonical correlation analysis
cancor.out1<-cancor(x = ds[,set_x], y = ds[,set_y]) 
summary(cancor.out1)

```

### 1. How many canonical correlations are significant? 
 
  The **H0 test** indicate that the __first five canonical__ correlations are significant because, __Pr(>F)__ is lower than significance level of __'0.05' (5%)__. This result shows that __H0__: 
 __"The canonical correlations in the current row and all that follow are zero"__, thus can be rejected.

### 2. How can you interpret the canonical variates?
  For the current analysis there are 5significant  canonical correlations, however, three of them explain the higher amount of variance. For that reason, the first three are selected.
  
 __CC1 ->__ Is represented by religious beliefs on x variables and interpersonal matters on the y variables.
    Less regiliosity more justification in sexual behavior (such as homosexuality,prostitution, abortion, divorce, sex before marriage.)
  
 __CC2 ->__ Is represented by ocurrency of Police or military interfere in peoples's private life on x variables and ocurrence of crimes (such as cheating_taxes & stealing_property) on y variable.
  
 __CC3 ->__ Is represented by ocurrency of Police or military interfere in peoples's private life & Racist behavior on x variables and ocurrence of crimes (such as violence, J_accept_bribe, J_cheating_taxes, J_stealing_property & stealing_property) on y variable.
 
### 3. How much variance in the Y variables can be explained by the X variables?
  By using just the first canonical correlation __92.84477__ percent of the variance can be explained.

```{r 5step_x}

#cancor.out2<-cancor(cbind(J_avoiding_fare, J_stealing_property, J_cheating_taxes, J_accept_bribe, #J_homosexuality, J_prostitution, J_abortion, J_divorce, J_sex_before_marriage, J_suicide, J_beat_wife, #J_parents_beating_children, J_violence)
#                    ~
#R_attend_religious_services+R_pray+R_importance_God+ CR_robberies+ CR_alcohol+ CR_police_military+ #CR_racist_behavior+ CR_drug_sale, data = ds)  

#summary(cancor.out2)

#print canonical loadings
cancor.out1$structure$X.xscores
cancor.out1$structure$Y.yscores

#print redundancies
redu<-redundancy(cancor.out1)
round(redu$Xcan,3)
round(redu$Ycan,3)

#computation redundancies from output
R2tu<-cancor.out1$cancor^2
VAFYbyt<-apply(cancor.out1$structure$Y.yscores^2,2,sum)/5
redund<-R2tu*VAFYbyt
a<- round(cbind(R2tu,VAFYbyt,redund,total=cumsum(redund)),3)

```



# [Annexes] 

## Codebook

### Table 1

| Column | Variable | Item |
|-|:--|:--------|
| 1 | V_creative | It is important to this person to think up new ideas and be creative; to do things one’s own way. |
| 2 | V_rich | It is important to this person to be rich; to have a lot of money and expensive things. |
| 3 | V_secure | Living in secure surroundings is important to this person; to avoid anything that might be dangerous. |
| 4 | V_spoil_oneself | It is important to this person to have a good time;to “spoil” oneself. |
| 5 | V_do_good | It is important to this person to do something for the good of |
| 6 | V_be_successful | Being very successful is important to this person; to have people recognize one’s achievements. |
| 7 | V_exciting_life | Adventure and taking risks are important to this person; to have an exciting life. |
| 8 | V_behave_properly | It is important to this person to always behave properly; to avoid doing anything people would say is wrong. |
| 9 | V_protect_environment | Looking after the environment is important to this person; to care for nature and save life resources. |
| 10 | V_tradition | Tradition is important to this person; to follow the customs handed down by one’s religion or family |

### Table 2

| Column | Variable | Item |
|-|:--|:--------|
| 11 | CR_robberies | Robberies |
| 12 | CR_alcohol | Alcohol consumption in the streets |
| 13 | CR_police_military | Police or military interfere with people’s private life |
| 14 | CR_racist_behavior | Racist behavior |
| 15 | CR_drug_sale | Drug sale in streets |

### Table 3

| Column | Variable | Item |
|-|:--|:--------|
| 16 | J_claiming_benefits | Claiming government benefits to which you are not entitled |
| 17 | J_avoiding_fare | Avoiding a fare on public transport |
| 18 | J_stealing_property | Stealing property |
| 19 | J_cheating_taxes | Cheating on taxes if you have a chance |
| 20 | J_accept_bribe | Someone accepting a bribe in the course of their duties |
| 21 | J_homosexuality | Homosexuality |
| 22 | J_prostitution | Prostitution |
| 23 | J_abortion | Abortion |
| 24 | J_divorce | Divorce |
| 25 | J_sex_before_marriage | Sex before marriage |
| 26 | J_suicide | Suicide |
| 27 | J_beat_wife | For a man to beat his wife |
| 28 | J_parents_beating_children | Parents beating children |
| 29 | J_violence | Violence against other people |


### Table 4

| Column | Variable | Item |
|-|:--|:--------|
| 30 | R_attend_religious_services | Apart from weddings and funerals, about how often do you attend religious services these days? 1=never, practically never,…,7=more than once a week |
| 31 | R_pray | Apart from weddings and funerals, about how often do you pray? 1=never, practically never,…,8=more than once a week |
| 32 | R_importance_God | How important is God in your life? 1=not at all important, …, 10=very important |






## Libraries

* [maptools](https://cran.r-project.org/web/packages/maptools/index.html) - maptools 
* [dplyr](https://cran.r-project.org/web/packages/dplyr/index.html) - dplyr
* [Matrix.utils](https://cran.r-project.org/web/packages/Matrix.utils/index.html) -  Matrix.utils
* [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html) -  ggplot2 
* [lavaan](https://cran.r-project.org/web/packages/lavaan/lavaan.pdf) - lavaan
* [candisc](https://cran.r-project.org/web/packages/candisc/index.html) - candisc
* [semTools](https://cran.r-project.org/web/packages/semTools/index.html) - semTools
* [semPlot](https://cran.r-project.org/web/packages/semPlot/semPlot.pdf) - semPlot
* [knitr](https://cran.r-project.org/web/packages/knitr/index.html) - knitr
* [tables](https://cran.r-project.org/web/packages/tables/vignettes/tables.pdf) - tables

